name: Pet Shop CI/CD

on:
  #push:
  #  branches: [ "main" ]
  #pull_request:
  #  branches: [ "main" ]
  workflow_dispatch:
    inputs:
      network_url:
        description: 'Network URL for contract deployment'
        required: true
        type: string
        default: 'https://ganache.ajripa.click' # This services is deployed in our K8S cluster
      helm_chart_name:
        description: 'Helm chart name'
        required: true
        type: string
        default: 'tfg-truffle-pet-shop'
jobs:
  deploy-contracts:
    name: Deploy Contracts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm

      - name: Install dependencies
        run: |
          npm install
          npm install -g truffle

      - name: Run Truffle migrations
        run: |
          truffle compile
          truffle migrate --network live
          truffle test --network live
        env:
          LIVE_URL: ${{ inputs.network_url }}

      - name: Upload contract artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dapp-files
          path: |
            src/
            build/contracts/
          retention-days: 1

  build-and-push:
    name: Build and Push Docker image
    runs-on: ubuntu-latest
    needs: deploy-contracts
    outputs:
      image_tag: ${{ env.IMAGE_TAG }}
      repo_name: ${{ env.REPO_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dapp files
        uses: actions/download-artifact@v4
        with:
          name: dapp-files
          path: .

      - name: Verify downloaded files
        run: |
          ls -la src/
          ls -la build/contracts/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Prepare ECR repository name based on the Github repository
        shell: bash
        run: |
          set -eux
          # lowercase the name
          repo="${GITHUB_REPOSITORY,,}"

          # replace / with _
          echo "REPO_NAME=${repo//\//_}" >> $GITHUB_ENV

      - name: Create ECR repository if it doesn't exist
        shell: bash
        run: |
          set -eux
          if ! aws ecr describe-repositories --repository-names "$REPO_NAME" > /dev/null 2>&1; then
            aws ecr create-repository --repository-name "$REPO_NAME"
            echo "ECR repository $REPO_NAME created."
          else
            echo "ECR repository $REPO_NAME already exists."
          fi

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create tag based on the current timestamp
        id: tag-timestamp
        run: echo "IMAGE_TAG=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_ENV

      - name: Build, tag, and push Docker image to Amazon ECR
        id: build-push
        shell: bash
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/$REPO_NAME:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$REPO_NAME:$IMAGE_TAG
          echo "IMAGE $IMAGE_TAG is pushed to $ECR_REGISTRY/$REPO_NAME"
          echo "image_tag=$IMAGE_TAG"
          echo "full_image=$ECR_REGISTRY/$REPO_NAME:$IMAGE_TAG"

  update-helm-chart:
      name: Update Helm Chart
      runs-on: ubuntu-latest
      needs: build-and-push
      permissions:
        contents: write

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Update values-tfg.yaml
          run: |
            cd chart/${{ inputs.helm_chart_name }}
            # Update image repository
            sed -i "s|repository: .*|repository: ${{ needs.build-and-push.outputs.repo_name }}|g" values-tfg.yaml
            # Update image tag
            sed -i "s|tag: .*|tag: ${{ needs.build-and-push.outputs.image_tag }}|g" values-tfg.yaml
            # Update live url
            sed -i "s|liveUrl: .*|liveUrl: ${{ inputs.network_url }}|g" values-tfg.yaml

            # Verify changes
            cat values-tfg.yaml

        - name: Commit and push changes
          run: |
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'github-actions@github.com'
            git add chart/${{ inputs.helm_chart_name }}/values-tfg.yaml
            git commit -m "chore: image tag ${{ needs.build-and-push.outputs.image_tag }} and network url ${{ inputs.network_url }}"
            git push